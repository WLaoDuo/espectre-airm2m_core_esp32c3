name: ESPHome Build

# 触发条件：推送到 main 分支或手动点击运行
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出你的代码
      - uses: actions/checkout@v4

      # 2. 读取缓存以加快以后编译的速度
      - name: Cache ESPHome
        uses: actions/cache@v4
        with:
          path: .esphome
          # key 的设计建议包含 esphome 版本或系统平台，
          # 这里使用 hashFiles 监控所有 yaml 变动是正确的
          key: esphome-cache-${{ runner.os }}-${{ hashFiles('*.yaml') }}
          restore-keys: |
            esphome-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome
          
      - name: Compile
        run: esphome compile examples/airm2m_core_esp32c3.yaml --binary-path .esphome/build/airm2m_core_esp32c3.bin
      
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: device-firmware
          path: .esphome/build/airm2m_core_esp32c3.bin
